<html>
<head><title>Parallax Wi-Fi Module Configuration - Update Settings</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <div id="main">
    <div class="header">
      <h1>Settings</h1>
    </div>
    <div class="content">
      <form action='#' onsubmit="return false;">
        <table>
          <tr>
            <td>Module name:</td>
            <td><input id="module-name" type="text"></td>
          </tr>
          <tr>
            <td>Loader Baud Rate:</td>
            <td>
              <select id="loader-baud-rate">
                <option value="1200">1200</option>
                <option value="4800">4800</option>
                <option value="9600">9600</option>
                <option value="19200">19200</option>
                <option value="38400">38400</option>
                <option value="57600">57600</option>
                <option value="74880">74880</option>
                <option value="115200">115200</option>
                <option value="230400">230400</option>
                <option value="460800">460800</option>
                <option value="921600">921600</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Communications Baud Rate:</td>
            <td>
            <select id="baud-rate">
                <option value="1200">1200</option>
                <option value="4800">4800</option>
                <option value="9600">9600</option>
                <option value="19200">19200</option>
                <option value="38400">38400</option>
                <option value="57600">57600</option>
                <option value="74880">74880</option>
                <option value="115200">115200</option>
                <option value="230400">230400</option>
                <option value="460800">460800</option>
                <option value="921600">921600</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Serial Protocol (SSCP):</td>
            <td>
              <select id="enable-serial-protocol">
                <option value="0">Disabled</option>
                <option value="1">Enabled</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>SSCP Start Character:</td>
            <td>
              <select id="start-char">
                <option value="254">0xFE</option>
                <option value="36">'$'</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>SSCP Pause Time in MS:</td>
            <td><input id="pause-time" type="text"></td>
          </tr>
          <tr>
            <td>SSCP Pause After Characters:</td>
            <td><input id="pause-chars" type="text"></td>
          </tr>
        </table>
        <h2>Save Settings</h2>
        <p>
          <input type='button' value='Save' onclick='on_save();'>
          <input type='button' value='Save to Flash' onclick='on_saveToFlash();'>
          <input type='button' value='Restore from Flash' onclick='on_restore();'>
          <input type='button' value='Restore Defaults' onclick='on_restoreDefaults();'>
        </p>
      </form>
      <p id='message'></p>
    </div>
  </div>
  <div id="logo"></div>

<script type='text/javascript'>

var moduleNameCtl;
var versionCtl;
var loaderBaudRateCtl;
var baudRateCtl;
var enableSerialProtocolCtl;
var startCharCtl;
var pauseTimeCtl;
var pauseCharsCtl;

function init()
{
    moduleNameCtl = document.getElementById('module-name');
    loaderBaudRateCtl = document.getElementById('loader-baud-rate');
    baudRateCtl = document.getElementById('baud-rate');
    enableSerialProtocolCtl = document.getElementById('enable-serial-protocol');
    startCharCtl = document.getElementById('start-char');
    pauseTimeCtl = document.getElementById('pause-time');
    pauseCharsCtl = document.getElementById('pause-chars');
    loadSettings();
}

function loadSettings() {
    var loaderBaudRate, baudRate;

    moduleNameCtl.value = getModuleName();
    loaderBaudRate = getBaudRate('loader-baud-rate');
    for (var i = 0; i < loaderBaudRateCtl.length; ++i)
        if (loaderBaudRate == loaderBaudRateCtl[i].value) {
            loaderBaudRateCtl.selectedIndex = i;
            break;
        }

    baudRate = getBaudRate('baud-rate');
    for (var i = 0; i < baudRateCtl.length; ++i)
        if (baudRate == baudRateCtl[i].value) {
            baudRateCtl.selectedIndex = i;
            break;
        }

    if (getEnableSerialProtocol() == "0")
        enableSerialProtocolCtl.selectedIndex = 0;
    else
        enableSerialProtocolCtl.selectedIndex = 1;
    if (getStartChar() == 254)
        startCharCtl.selectedIndex = 0;
    else
        startCharCtl.selectedIndex = 1;
    
    pauseTimeCtl.value = getPauseTime();
    pauseCharsCtl.value = getPauseChars();
}

function on_save() {
    setMessage("Saving...");
    setModuleName(moduleNameCtl.value);
    setBaudRate('loader-baud-rate', loaderBaudRateCtl.value);
    setBaudRate('baud-rate', baudRateCtl.value);
    setEnableSerialProtocol(enableSerialProtocolCtl.value);
    setStartChar(startCharCtl.value);
    setPauseTime(pauseTimeCtl.value);
    setPauseChars(pauseCharsCtl.value);
    setMessage("Settings saved");
}

function on_saveToFlash() {
    on_save();
    var req = new XMLHttpRequest();
    req.open('POST', '/parallax/save-settings', false);
    req.send();
    setMessage("Settings saved to flash");
}

function on_restore() {
    setMessage("Restoring settings...");
    var req = new XMLHttpRequest();
    req.open('POST', '/parallax/restore-settings', false);
    req.send();
    loadSettings();
    setMessage("Settings restored from flash");
}

function on_restoreDefaults() {
    setmessage("Restoring default settings...");
    var req = new XMLHttpRequest();
    req.open('POST', '/parallax/restore-default-settings', false);
    req.send();
    loadSettings();
    setMessage("Default settings restored");
}

function setMessage(msg) {
    var message = document.getElementById('message');
    message.innerHTML = msg;
}

function getModuleName() {
    var req = new XMLHttpRequest();
    req.open('GET', '/parallax/setting?name=module-name', false);
    req.send();
    return req.responseText;
}

function setModuleName(name) {
    var req = new XMLHttpRequest();
    var url = '/parallax/setting?name=module-name&value=' + name;
    req.open('POST', url, false);
    req.send();
}

function getBaudRate(which) {
    var req = new XMLHttpRequest();
    var url = '/parallax/setting?name=' + which;
    req.open('GET', url, false);
    req.send();
    return req.responseText;
}

function setBaudRate(which, baudRate) {
    var req = new XMLHttpRequest();
    var url = '/parallax/setting?name=' + which + '&value=' + baudRate;
    req.open('POST', url, false);
    req.send();
}

function getEnableSerialProtocol() {
    var req = new XMLHttpRequest();
    req.open('GET', '/parallax/setting?name=sscp-enable', false);
    req.send();
    return req.responseText;
}

function setEnableSerialProtocol(enable) {
    var req = new XMLHttpRequest();
    var url = '/parallax/setting?name=sscp-enable&value=' + enable;
    req.open('POST', url, false);
    req.send();
}

function getStartChar() {
    var req = new XMLHttpRequest();
    req.open('GET', '/parallax/setting?name=sscp-start-char', false);
    req.send();
    return req.responseText;
}

function setStartChar(ch) {
    var req = new XMLHttpRequest();
    var url = '/parallax/setting?name=sscp-start-char&value=' + ch;
    req.open('POST', url, false);
    req.send();
}

function getPauseTime() {
    var req = new XMLHttpRequest();
    req.open('GET', '/parallax/setting?name=sscp-pause-time', false);
    req.send();
    return req.responseText;
}

function setPauseTime(time) {
    var req = new XMLHttpRequest();
    var url = '/parallax/setting?name=sscp-pause-time&value=' + time;
    req.open('POST', url, false);
    req.send();
}

function getPauseChars() {
    var req = new XMLHttpRequest();
    req.open('GET', '/parallax/setting?name=sscp-pause-chars', false);
    req.send();
    return req.responseText;
}

function setPauseChars(chars) {
    var req = new XMLHttpRequest();
    var url = '/parallax/setting?name=sscp-pause-chars&value=' + chars;
    req.open('POST', url, false);
    req.send();
}

window.addEventListener("load", init, false);

</script>
</body>
</html>

